#!/usr/bin/env bash
# Copyright 2026 Siddharth Viswanathan
# This file was fully generated by Codex and may contain modifications by Siddharth Viswanathan as of 2026.
# SPDX-License-Identifier: Apache-2.0

set -euo pipefail

usage() {
  cat <<'EOF'
Usage:
  configure_peer.sh --peer-url URL [options]

Options:
  --peer-url URL      Peer daemon base URL (required), e.g. http://192.168.1.24:8787
  --repo PATH         Repository root (default: current directory)
  --vcs-bin PATH      Path to vcs binary (default: <repo>/vcs)
  --local-url URL     Local daemon URL (default: http://127.0.0.1:8787)
  --no-sync           Skip immediate sync after adding peer
  --remove            Remove peer instead of adding it
  -h, --help          Show this help

Examples:
  ./benchmarking/lan/configure_peer.sh --peer-url http://192.168.1.24:8787
  ./benchmarking/lan/configure_peer.sh --peer-url http://192.168.1.24:8787 --remove
EOF
}

require_command() {
  if ! command -v "$1" >/dev/null 2>&1; then
    echo "error: required command not found: $1" >&2
    exit 1
  fi
}

extract_node_id_from_json() {
  local json_input="$1"
  local compact
  compact="$(printf '%s' "$json_input" | tr -d '\r\n')"
  printf '%s' "$compact" | sed -n 's/.*"node_id"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' | head -n1
}

extract_peers_from_json() {
  local json_input="$1"
  local compact
  compact="$(printf '%s' "$json_input" | tr -d '\r\n')"
  printf '%s' "$compact" | sed -n 's/.*"peers"[[:space:]]*:[[:space:]]*\(\[[^]]*\]\).*/\1/p' | head -n1
}

REPO_PATH="$(pwd)"
VCS_BIN=""
LOCAL_URL="http://127.0.0.1:8787"
PEER_URL=""
DO_SYNC=1
REMOVE_ONLY=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --peer-url)
      PEER_URL="$2"
      shift 2
      ;;
    --repo)
      REPO_PATH="$2"
      shift 2
      ;;
    --vcs-bin)
      VCS_BIN="$2"
      shift 2
      ;;
    --local-url)
      LOCAL_URL="$2"
      shift 2
      ;;
    --no-sync)
      DO_SYNC=0
      shift
      ;;
    --remove)
      REMOVE_ONLY=1
      shift
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "error: unknown argument: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [[ -z "$PEER_URL" ]]; then
  echo "error: --peer-url is required" >&2
  usage
  exit 1
fi

if [[ -z "$VCS_BIN" ]]; then
  VCS_BIN="$REPO_PATH/vcs"
fi

if [[ ! -d "$REPO_PATH/.git" ]]; then
  echo "error: --repo must point to a git repository root: $REPO_PATH" >&2
  exit 1
fi
if [[ ! -x "$VCS_BIN" ]]; then
  echo "error: vcs binary is not executable: $VCS_BIN" >&2
  exit 1
fi

require_command curl
require_command sed
require_command tr

cd "$REPO_PATH"

if [[ "$REMOVE_ONLY" -eq 1 ]]; then
  "$VCS_BIN" peer remove "$PEER_URL"
else
  "$VCS_BIN" peer add "$PEER_URL"
  if [[ "$DO_SYNC" -eq 1 ]]; then
    "$VCS_BIN" sync --peer "$PEER_URL"
  fi
fi

echo
echo "Peer list:"
"$VCS_BIN" peer list || true

echo
echo "Local daemon status from $LOCAL_URL/v1/node"
LOCAL_JSON="$(curl -fsS "${LOCAL_URL%/}/v1/node")"
LOCAL_NODE_ID="$(extract_node_id_from_json "$LOCAL_JSON")"
LOCAL_PEERS="$(extract_peers_from_json "$LOCAL_JSON")"
if [[ -z "$LOCAL_NODE_ID" ]]; then
  LOCAL_NODE_ID="<unparsed>"
fi
if [[ -z "$LOCAL_PEERS" ]]; then
  LOCAL_PEERS="<unparsed>"
fi
echo "  node_id: $LOCAL_NODE_ID"
echo "  peers:   $LOCAL_PEERS"

echo
echo "Remote daemon status from ${PEER_URL%/}/v1/node"
REMOTE_JSON="$(curl -fsS "${PEER_URL%/}/v1/node")"
REMOTE_NODE_ID="$(extract_node_id_from_json "$REMOTE_JSON")"
REMOTE_PEERS="$(extract_peers_from_json "$REMOTE_JSON")"
if [[ -z "$REMOTE_NODE_ID" ]]; then
  REMOTE_NODE_ID="<unparsed>"
fi
if [[ -z "$REMOTE_PEERS" ]]; then
  REMOTE_PEERS="<unparsed>"
fi
echo "  node_id: $REMOTE_NODE_ID"
echo "  peers:   $REMOTE_PEERS"
