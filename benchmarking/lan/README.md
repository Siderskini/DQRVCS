<!--
Copyright 2026 Siddharth Viswanathan
This file was fully generated by Codex and may contain modifications by Siddharth Viswanathan as of 2026.
SPDX-License-Identifier: Apache-2.0
-->

# Two-Node LAN Benchmarking (Ubuntu + Mac)

This runbook benchmarks communication speed between two devices on the same local network using the VCS gossip layer.

It is designed for your current setup:

- Node A: Ubuntu 24 machine
- Node B: MacBook
- Both nodes already have this repo cloned and `vcs` built

## What These Benchmarks Measure

1. `sync_rtt`
- Measures elapsed time for `vcs sync --peer <remote>`.
- Captures end-to-end sync command round-trip on LAN.

2. `replication_latency`
- Measures elapsed time from local `vcs op append` on Node A to remote Node B reflecting that sequence in `/v1/node` summary.
- This captures practical one-way propagation latency.

## Scripts

- `start_daemon.sh`
  - Starts `vcs daemon` with LAN-friendly defaults.
- `configure_peer.sh`
  - Adds/removes peer and optionally runs immediate sync.
- `run_two_node_benchmark.sh`
  - Driver benchmark script (run from Node A, targeting Node B).
  - Writes raw CSV and summary reports.

## Pre-Run Checklist

- Both devices are on the same subnet and can reach each other by IP.
- Firewalls allow TCP access to daemon port (default `8787`).
- Standard shell tools are available (`bash`, `curl`, `awk`, `sed`, `grep`, `sort`, `tr`).
- `vcs` binary is executable on both machines.

## Step-by-Step

### 1) Start daemon on Node B (MacBook)

From Node B repo root:

```bash
./benchmarking/lan/start_daemon.sh \
  --repo "$PWD" \
  --listen 0.0.0.0:8787 \
  --interval 1s
```

### 2) Start daemon on Node A (Ubuntu)

From Node A repo root:

```bash
./benchmarking/lan/start_daemon.sh \
  --repo "$PWD" \
  --listen 0.0.0.0:8787 \
  --interval 1s
```

### 3) Configure peers

On Node A:

```bash
./benchmarking/lan/configure_peer.sh \
  --repo "$PWD" \
  --peer-url "http://<MACBOOK_LAN_IP>:8787"
```

On Node B:

```bash
./benchmarking/lan/configure_peer.sh \
  --repo "$PWD" \
  --peer-url "http://<UBUNTU_LAN_IP>:8787"
```

### 4) Run benchmark from Node A (driver)

```bash
./benchmarking/lan/run_two_node_benchmark.sh \
  --repo "$PWD" \
  --remote-url "http://<MACBOOK_LAN_IP>:8787" \
  --iterations 50 \
  --warmup 10 \
  --mode manual-sync
```

### 5) (Optional) Reverse roles

Run the same command from Node B against Node A to compare directionality.

## Output Artifacts

Each run creates a directory:

```text
benchmarking/results/lan/<timestamp>[-tag]/
```

Files:

- `sync_rtt.csv`
- `replication_latency.csv`
- `summary.json`
- `summary.md`

## Recommended Configurations

- For raw communication speed: `--mode manual-sync`
  - Minimizes dependence on periodic daemon schedule.
- For realistic background behavior: `--mode passive-daemon`
  - Uses daemon gossip loop behavior; can be noisier.

## Troubleshooting

- If `configure_peer.sh` cannot fetch `/v1/node`:
  - Verify daemon is running.
  - Verify correct LAN IP and port.
  - Verify firewall rules.
- If replication timeouts occur:
  - Increase `--timeout-ms`.
  - In passive mode, lower daemon interval (`--interval 1s` or lower).
  - Validate both peers are configured (`vcs peer list`).

## Notes

- These benchmarks target two-node LAN communication only.
- They do not include QLS/QRL integration performance.
- They do not replace the local wrapper overhead benchmarks in `benchmarking/runner.go`.
