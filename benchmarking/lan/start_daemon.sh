#!/usr/bin/env bash
# Copyright 2026 Siddharth Viswanathan
# This file was fully generated by Codex and may contain modifications by Siddharth Viswanathan as of 2026.
# SPDX-License-Identifier: Apache-2.0

set -euo pipefail

usage() {
  cat <<'EOF'
Usage:
  start_daemon.sh [options]

Options:
  --repo PATH         Repository root (default: current directory)
  --vcs-bin PATH      Path to vcs binary (default: <repo>/vcs)
  --listen ADDR       Listen address (default: 0.0.0.0:8787)
  --interval DUR      Gossip interval (default: 1s)
  --limit N           Sync limit per request (default: 256)
  --rounds N          Max anti-entropy rounds per peer (default: 6)
  -h, --help          Show this help

Example:
  ./benchmarking/lan/start_daemon.sh --repo /path/to/VCS --listen 0.0.0.0:8787 --interval 1s
EOF
}

REPO_PATH="$(pwd)"
VCS_BIN=""
LISTEN_ADDR="0.0.0.0:8787"
INTERVAL="1s"
SYNC_LIMIT="256"
SYNC_ROUNDS="6"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --repo)
      REPO_PATH="$2"
      shift 2
      ;;
    --vcs-bin)
      VCS_BIN="$2"
      shift 2
      ;;
    --listen)
      LISTEN_ADDR="$2"
      shift 2
      ;;
    --interval)
      INTERVAL="$2"
      shift 2
      ;;
    --limit)
      SYNC_LIMIT="$2"
      shift 2
      ;;
    --rounds)
      SYNC_ROUNDS="$2"
      shift 2
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "error: unknown argument: $1" >&2
      usage
      exit 1
      ;;
  esac
done

if [[ -z "$VCS_BIN" ]]; then
  VCS_BIN="$REPO_PATH/vcs"
fi

if [[ ! -d "$REPO_PATH/.git" ]]; then
  echo "error: --repo must point to a git repository root: $REPO_PATH" >&2
  exit 1
fi
if [[ ! -x "$VCS_BIN" ]]; then
  echo "error: vcs binary is not executable: $VCS_BIN" >&2
  exit 1
fi

echo "Starting daemon with:"
echo "  repo:     $REPO_PATH"
echo "  vcs-bin:  $VCS_BIN"
echo "  listen:   $LISTEN_ADDR"
echo "  interval: $INTERVAL"
echo "  limit:    $SYNC_LIMIT"
echo "  rounds:   $SYNC_ROUNDS"
echo

cd "$REPO_PATH"
exec "$VCS_BIN" daemon \
  --listen "$LISTEN_ADDR" \
  --interval "$INTERVAL" \
  --limit "$SYNC_LIMIT" \
  --rounds "$SYNC_ROUNDS"
