<!--
Copyright 2026 Siddharth Viswanathan
This file was fully generated by Codex and may contain modifications by Siddharth Viswanathan as of 2026.
SPDX-License-Identifier: Apache-2.0
-->

# Benchmarking `vcs` vs `git`

This directory contains reproducible benchmark tooling for:

- local wrapper overhead (`vcs` vs native `git`)
- two-device LAN communication performance

> Note: Published cross-device benchmark results are still pending and will be added soon. The runnable LAN scripts are now available in `benchmarking/lan/`.

## Goals

- Compare simple local operations between `git` and `vcs`.
- Measure wrapper overhead in milliseconds and percent.
- Produce machine-readable and human-readable reports.

## Included Benchmark Tooling

- `runner.go`: benchmark harness that:
  - creates a synthetic repository workload,
  - runs matched scenarios against `git` and `vcs`,
  - reports mean/median/p95/stddev/min/max,
  - computes overhead ratio and percent.
- `run.sh`: convenience wrapper that writes timestamped reports.
- `lan/start_daemon.sh`: starts a gossip daemon with benchmarking defaults.
- `lan/configure_peer.sh`: configures and validates peer connectivity.
- `lan/run_two_node_benchmark.sh`: driver benchmark for two-device LAN speed tests.
- `lan/README.md`: step-by-step runbook for Ubuntu + Mac two-node benchmarking.

## Scenarios Covered

- `status --short` (clean tree)
- `log -n 1 --oneline`
- `branch --list`
- `checkout bench-other` (with cleanup back to `main`)
- stage one file (`git add` vs `vcs stage`)
- unstage one file (`git restore --staged` vs `vcs unstage`)
- empty commit (`git commit --allow-empty -m ...` vs `vcs commit --allow-empty -m ...`)

## Quick Start

From the repository root:

```bash
go build -o vcs .
./benchmarking/run.sh
```

Reports are written to:

```text
benchmarking/results/<timestamp>/
  report.json
  report.md
```

## Direct Runner Usage

```bash
go run ./benchmarking/runner.go \
  --git-bin git \
  --vcs-bin ./vcs \
  --iterations 40 \
  --warmup 8 \
  --timeout 15s \
  --json-out benchmarking/results/manual/report.json \
  --md-out benchmarking/results/manual/report.md
```

## Methodology Notes

- `git` and `vcs` run on separate cloned repos per scenario to reduce cross-interference.
- Warmup runs are excluded from final stats.
- Overhead is calculated as:
  - `overhead_ratio = vcs_mean / git_mean`
  - `overhead_pct = (overhead_ratio - 1) * 100`

## Practical Tips for Stable Results

- Close CPU-heavy background tasks.
- Run on AC power.
- Execute multiple benchmark runs and compare medians.
- Use the same disk and environment for both binaries.

## Published Results (Ubuntu 24)

The following benchmark run was performed on Siddharth Viswanathan's Ubuntu 24 machine.

- Run timestamp (UTC): `2026-02-10T04:13:37Z`
- Host: `linux/amd64`
- git binary: `/usr/bin/git`
- vcs binary: `<repo>/vcs`
- Iterations: `40` (warmup `8`)
- Source files:
  - `benchmarking/results/20260210T041333Z/report.json`
  - `benchmarking/results/20260210T041333Z/report.md`

| Scenario | git mean (ms) | vcs mean (ms) | Overhead (%) | git p95 (ms) | vcs p95 (ms) |
|---|---:|---:|---:|---:|---:|
| `status_short_clean` | 2.648 | 3.951 | 49.24 | 3.010 | 4.529 |
| `log_head_oneline` | 0.817 | 2.166 | 165.23 | 0.894 | 2.345 |
| `branch_list` | 0.747 | 2.108 | 182.43 | 0.796 | 2.237 |
| `checkout_branch` | 2.680 | 3.230 | 20.49 | 3.888 | 3.508 |
| `stage_single_file` | 2.552 | 3.628 | 42.17 | 2.920 | 4.578 |
| `unstage_single_file` | 2.543 | 3.922 | 54.20 | 2.920 | 4.515 |
| `commit_allow_empty` | 3.765 | 10.745 | 185.43 | 4.377 | 13.341 |

## Two-Device Runbook (Ubuntu + macOS)

Use this exact sequence to collect two-node LAN benchmark data.

### 1) Build and script permissions on both machines

From repo root:

```bash
go build -o vcs .
chmod +x benchmarking/lan/*.sh
```

### 2) Determine LAN IPs

On Ubuntu:

```bash
hostname -I
```

On macOS:

```bash
ipconfig getifaddr en0
```

Define:

- `UBUNTU_IP=<ubuntu_lan_ip>`
- `MAC_IP=<mac_lan_ip>`

### 3) Start daemon on macOS (keep terminal open)

```bash
./benchmarking/lan/start_daemon.sh \
  --repo "$PWD" \
  --listen 0.0.0.0:8787 \
  --interval 1s
```

### 4) Start daemon on Ubuntu (keep terminal open)

```bash
./benchmarking/lan/start_daemon.sh \
  --repo "$PWD" \
  --listen 0.0.0.0:8787 \
  --interval 1s
```

### 5) Configure peers in both directions

On Ubuntu:

```bash
./benchmarking/lan/configure_peer.sh \
  --repo "$PWD" \
  --peer-url "http://$MAC_IP:8787"
```

On macOS:

```bash
./benchmarking/lan/configure_peer.sh \
  --repo "$PWD" \
  --peer-url "http://$UBUNTU_IP:8787"
```

### 6) Run benchmark from Ubuntu targeting macOS

```bash
./benchmarking/lan/run_two_node_benchmark.sh \
  --repo "$PWD" \
  --remote-url "http://$MAC_IP:8787" \
  --iterations 50 \
  --warmup 10 \
  --mode manual-sync \
  --tag ubuntu-to-mac
```

### 7) Optional reverse-direction run (macOS targeting Ubuntu)

```bash
./benchmarking/lan/run_two_node_benchmark.sh \
  --repo "$PWD" \
  --remote-url "http://$UBUNTU_IP:8787" \
  --iterations 50 \
  --warmup 10 \
  --mode manual-sync \
  --tag mac-to-ubuntu
```

### 8) Collect output artifacts

Each run writes to:

```text
benchmarking/results/lan/<timestamp>-<tag>/
```

Files:

- `sync_rtt.csv`
- `replication_latency.csv`
- `summary.json`
- `summary.md`

Find latest run:

```bash
ls -1dt benchmarking/results/lan/* | head -n 1
```

Stop daemons with `Ctrl+C` in daemon terminals when finished.
