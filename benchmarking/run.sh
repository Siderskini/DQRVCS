#!/usr/bin/env bash
# Copyright 2026 Siddharth Viswanathan
# This file was fully generated by Codex and may contain modifications by Siddharth Viswanathan as of 2026.
# SPDX-License-Identifier: Apache-2.0

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TIMESTAMP="$(date -u +"%Y%m%dT%H%M%SZ")"
OUT_DIR="$SCRIPT_DIR/results/$TIMESTAMP"
JSON_OUT="$OUT_DIR/report.json"
MD_OUT="$OUT_DIR/report.md"

mkdir -p "$OUT_DIR"

GIT_BIN="${GIT_BIN:-git}"
VCS_BIN="${VCS_BIN:-$REPO_ROOT/vcs}"
ITERATIONS="${ITERATIONS:-40}"
WARMUP="${WARMUP:-8}"
TIMEOUT="${TIMEOUT:-15s}"

if [[ ! -x "$VCS_BIN" ]]; then
  echo "error: vcs binary not executable at: $VCS_BIN" >&2
  echo "hint: run 'go build -o vcs .' from repo root, or set VCS_BIN=/path/to/vcs" >&2
  exit 1
fi

echo "Running benchmark..."
echo "git: $GIT_BIN"
echo "vcs: $VCS_BIN"
echo "iterations: $ITERATIONS (warmup: $WARMUP)"
echo "timeout: $TIMEOUT"
echo "output: $OUT_DIR"
echo

(
  cd "$REPO_ROOT"
  go run ./benchmarking/runner.go \
    --git-bin "$GIT_BIN" \
    --vcs-bin "$VCS_BIN" \
    --iterations "$ITERATIONS" \
    --warmup "$WARMUP" \
    --timeout "$TIMEOUT" \
    --json-out "$JSON_OUT" \
    --md-out "$MD_OUT"
)

echo
echo "Benchmark complete."
echo "JSON report: $JSON_OUT"
echo "Markdown report: $MD_OUT"
